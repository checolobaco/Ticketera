const { Resend } = require('resend'); // üëà Nueva dependencia
const nodemailer = require('nodemailer');
const QRCode = require('qrcode');
const db = require('../db');

// --- OPCI√ìN A: GMAIL (Nodemailer) ---
const transporter = nodemailer.createTransport({
  host: 'smtp.gmail.com',
  port: 465,
  secure: true,
  auth: {
    user: process.env.GMAIL_USER || 'cloudticketts@gmail.com',
    pass: process.env.GMAIL_APP_PASSWORD || 'emiuximmhcuqpwic',
  },
  tls: { rejectUnauthorized: false },
  connectionTimeout: 40000,
});

// --- OPCI√ìN B: RESEND (API) ---
const resend = new Resend(process.env.RESEND_API_KEY);

async function sendTicketsEmailForOrder(orderId) {
  // 1) Reclamar env√≠o (IDEMPOTENCIA)
  const claim = await db.query(
    `UPDATE orders
        SET email_status = 'SENDING',
            email_last_error = NULL
      WHERE id = $1
        AND email_status IN ('PENDING')
        AND email_sent_at IS NULL
      RETURNING id, buyer_name, buyer_email`,
    [orderId]
  )

  if (!claim.rows.length) return { ok: true, skipped: true };

  const order = claim.rows[0];
  if (!order.buyer_email) {
    await db.query("UPDATE orders SET email_status='PENDING', email_last_error='NO_BUYER_EMAIL' WHERE id=$1", [orderId]);
    return { ok: false, error: 'NO_BUYER_EMAIL' };
  }

  try {
    // 2) Traer tickets + info
    const { rows: tickets } = await db.query(
      `SELECT t.id, t.unique_code, t.qr_payload, t.status, tt.name AS ticket_type_name,
              e.name AS event_name, e.start_datetime AS event_start_datetime, e.image_url AS event_image_url
       FROM tickets t
       JOIN ticket_types tt ON tt.id = t.ticket_type_id
       JOIN events e ON e.id = tt.event_id
       WHERE t.order_id = $1 ORDER BY t.created_at ASC`,
      [orderId]
    );

    if (!tickets.length) {
      await db.query("UPDATE orders SET email_status='PENDING', email_last_error='NO_TICKETS' WHERE id=$1", [orderId]);
      return { ok: false, error: 'NO_TICKETS' };
    }

    // 3) Armar HTML + QRs
    const eventName = tickets[0].event_name;
    const eventStart = new Date(tickets[0].event_start_datetime).toLocaleString();
    const eventImage = tickets[0].event_image_url || '';
    
    const attachments = [];
    const ticketBlocks = [];

    for (const t of tickets) {
      const cid = `qr-${t.id}@cloudtickets`;
      const pngBuffer = await QRCode.toBuffer(t.qr_payload, { type: 'png', margin: 1, scale: 6 });

      // Formato para Nodemailer (Gmail)
      attachments.push({
        filename: `ticket-${t.unique_code}.png`,
        content: pngBuffer,
        cid, 
        contentType: 'image/png',
      });

      ticketBlocks.push(`
        <div style="border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0;">
          <div style="display:flex;gap:14px;align-items:center;">
            <img src="cid:${cid}" width="140" height="140" style="border-radius:10px;border:1px solid #eee;" />
            <div>
              <div style="font-size:14px;color:#6b7280;">Tipo: <b>${escapeHtml(t.ticket_type_name || 'Ticket')}</b></div>
              <div style="font-size:14px;color:#6b7280;">C√≥digo:</div>
              <div style="font-size:18px;font-weight:700;">${escapeHtml(t.unique_code)}</div>
            </div>
          </div>
        </div>
      `);
    }

    const html = `
      <div style="font-family:Arial,Helvetica,sans-serif;max-width:680px;margin:0 auto;padding:18px;color:#111827;">
        <div style="border-radius:16px;padding:18px;background:#111827;color:#fff;">
          <div style="font-size:18px;font-weight:700;">CloudTickets</div>
          <div style="font-size:13px;opacity:.85;margin-top:4px;">Tus tickets est√°n listos üéüÔ∏è</div>
        </div>

        <div style="margin-top:18px;">
          <h2 style="margin:0 0 6px 0;">Hola ${escapeHtml(order.buyer_name || '')},</h2>
																

          <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:14px;">
            ${
              eventImage
                ? `<img src="${eventImage}" alt="Evento" style="width:100%;border-radius:10px;margin-bottom:12px;" />`
                : ''
            }

            <div style="font-size:12px;color:#6b7280;">Evento</div>
            <div style="font-size:18px;font-weight:700;">${escapeHtml(eventName)}</div>

            <div style="margin-top:6px;font-size:14px;color:#374151;">
              <strong>Fecha:</strong> ${escapeHtml(eventStart)}
            </div>
          </div>

          <div style="margin-top:16px;font-size:14px;color:#374151;">
            Presenta el QR de cada ticket en la entrada:
          </div>

          ${ticketBlocks.join('')}

          <div style="margin-top:16px;font-size:12px;color:#6b7280;">
            Si no ves los QR embebidos, revisa los adjuntos del correo.
          </div>
        </div>
      </div>

    // ---------------------------------------------------------
    // 4) ENVIAR CORREO (COMENTA UNA OPCI√ìN Y DESCOMENTA LA OTRA)
    // ---------------------------------------------------------

    // --- MODO GMAIL (Nodemailer) ---
    /*
    await transporter.sendMail({
      from: `"CloudTickets" <${process.env.GMAIL_USER}>`,
      to: order.buyer_email,
      subject: `Tus tickets - ${eventName}`,
      html,
      attachments,
    });
    */

    // --- MODO RESEND (API) ---
    // Nota: Si no tienes dominio verificado, usa 'onboarding@resend.dev' en 'from'
    const { data, error } = await resend.emails.send({
      from: 'CloudTickets <no-reply@cloudtickets.com>', 
      to: [order.buyer_email],
      subject: `Tus tickets - ${eventName}`,
      html: html,
      attachments: attachments.map(a => ({
        filename: a.filename,
        content: a.content.toString('base64'), // Resend requiere base64
      })),
    });
    if (error) throw error;

    // ---------------------------------------------------------

    // 5) Marcar como enviado
    await db.query(
      `UPDATE orders SET email_status='SENT', email_sent_at=NOW(), email_last_error=NULL WHERE id=$1`,
      [orderId]
    );

    return { ok: true, sentTo: order.buyer_email };

  } catch (err) {
    await db.query("UPDATE orders SET email_status='PENDING', email_last_error=$2 WHERE id=$1", [orderId, String(err?.message || err)]);
    throw err;
  }
}

function escapeHtml(str) { /* tu funcion escapeHtml */ }

module.exports = { sendTicketsEmailForOrder };